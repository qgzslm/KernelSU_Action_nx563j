name: Build Kernel
on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel by ${{ github.actor }}
    runs-on: ubuntu-22.04  # 升级至LTS支持周期内的版本
    env:
      PYTHON_VERSION: 2.7.18
    steps:
    - uses: actions/checkout@v4

    - name: Setup Configuration
      run: |
        # 优化环境变量提取方式
        while IFS= read -r line; do
          if [[ $line == KERNEL_* || $line == USE_* || $line == *_IMAGE* ]]; then
            key="${line%%=*}"
            value="${line#*=}"
            echo "$key=$value" >> $GITHUB_ENV
          fi
        done < config.env

    - name: Setup build environment
      run: |
        # 添加多架构支持
        sudo dpkg --add-architecture i386
        
        # 安装Python 2.7（通过deadsnakes PPA）
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository -y ppa:deadsnakes/ppa
        sudo apt-get install -y \
          python$PYTHON_VERSION \
          python$PYTHON_VERSION-dev \
          python-is-python3  # 保持python3为默认
        
        # 安装构建依赖
        sudo apt-get install -y \
          git ccache automake flex lzop bison gperf build-essential \
          zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev \
          squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng \
          maven libssl-dev lib32ncurses5-dev libx11-dev lib32z-dev \
          libgl1-mesa-dev xsltproc unzip device-tree-compiler \
          crossbuild-essential-arm64 crossbuild-essential-armhf
        
        # 创建Python2符号链接
        sudo ln -sf /usr/bin/python$PYTHON_VERSION /usr/local/bin/python2
        python2 --version

        # 初始化工作目录
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Download toolchains
      timeout-minutes: 15
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        # 使用镜像加速下载
        wget https://mirror.codebucket.de/android/prebuilts/clang/host/linux-x86/clang-${{ env.CLANG_VERSION }}.tar.gz \
          -O clang.tar.gz
        mkdir clang-aosp && tar -xzf clang.tar.gz -C clang-aosp --strip-components 1
        
        wget https://mirror.codebucket.de/android/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/android-12.1.0_r27.tar.gz \
          -O gcc-aosp.tar.gz
        mkdir gcc-aosp && tar -xzf gcc-aosp.tar.gz -C gcc-aosp --strip-components 1
        
        wget https://mirror.codebucket.de/android/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/android-12.1.0_r27.tar.gz \
          -O gcc32-aosp.tar.gz
        mkdir gcc32-aosp && tar -xzf gcc32-aosp.tar.gz -C gcc32-aosp --strip-components 1

    - name: Build Kernel
      env:
        KBUILD_BUILD_USER: ${{ github.actor }}
        KBUILD_BUILD_HOST: GitHub-Actions
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone --depth=1 --branch=${{ env.KERNEL_SOURCE_BRANCH }} \
          ${{ env.KERNEL_SOURCE }} android-kernel
        
        # 应用KernelSU补丁
        if [ "${{ env.USE_KERNELSU }}" = "true" ]; then
          curl -sSL "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s -- android-kernel
        fi
        
        # 编译配置
        export PATH="$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$PATH"
        make -j$(nproc) -C android-kernel O=out \
          ARCH=${{ env.TARGET_ARCH }} \
          CC=clang \
          CROSS_COMPILE=aarch64-linux-android- \
          CROSS_COMPILE_ARM32=arm-linux-androideabi- \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          ${{ env.BUILD_EXTRA_COMMAND }} \
          ${{ env.KERNEL_DEFCONFIG }}

        # 执行编译
        make -j$(nproc) -C android-kernel O=out \
          ARCH=${{ env.TARGET_ARCH }} \
          CC=clang \
          CROSS_COMPILE=aarch64-linux-android- \
          CROSS_COMPILE_ARM32=arm-linux-androideabi- \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          ${{ env.BUILD_EXTRA_COMMAND }}

    - name: Package artifacts
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ env.DEVICE }}-${{ github.run_id }}
        path: |
          $GITHUB_WORKSPACE/kernel_workspace/android-kernel/out/arch/${{ env.TARGET_ARCH }}/boot/*
