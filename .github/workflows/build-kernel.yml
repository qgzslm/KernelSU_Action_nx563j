# .github/workflows/build-kernel.yml
name: Build Kernel
on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel by ${{ github.actor }}
    runs-on: ubuntu-22.04
    env:
      PYTHON_VERSION: 2.7
    steps:
    - uses: actions/checkout@v4

    # ğŸ”§ ä¿®å¤ç¯å¢ƒå˜é‡åŠ è½½é€»è¾‘
    - name: Load Config
      run: |
        grep -E '^(KERNEL_|USE_|DEVICE|CLANG)' config.env | sed 's/^/export /' >> $GITHUB_ENV

    # ğŸ”§ å½»åº•é‡å»ºAPTæºé…ç½®
    - name: Setup Build Environment
      run: |
        # æ¸…é™¤é”™è¯¯é…ç½®
        sudo rm -f /etc/apt/sources.list.d/*
        # ä½¿ç”¨æ¸…åé•œåƒæº
        sudo tee /etc/apt/sources.list << EOL
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-security main restricted universe multiverse
        EOL

        # ğŸ”§ ä¿®å¤å¤šæ¶æ„æ”¯æŒ
        sudo dpkg --add-architecture arm64
        sudo dpkg --add-architecture armhf
        sudo apt-get update -y
        sudo apt --fix-broken install -y

        # ğŸ”§ æŒ‡å®šæ¶æ„å®‰è£…ä¾èµ–
        sudo apt-get install -y \
          python${PYTHON_VERSION} \
          python${PYTHON_VERSION}-dev \
          crossbuild-essential-arm64 \
          crossbuild-essential-armhf \
          libssl-dev:arm64=3.0.2-0ubuntu1.10 \
          libssl-dev:armhf=3.0.2-0ubuntu1.10 \
          binutils-aarch64-linux-gnu \
          binutils-arm-linux-gnueabihf

    # ğŸ”§ ä¼˜åŒ–ä¸‹è½½é‡è¯•æœºåˆ¶
    - name: Download Toolchains
      timeout-minutes: 5
      run: |
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace
        cd $GITHUB_WORKSPACE/kernel_workspace
        
        wget --tries=3 --retry-connrefused \
          https://mirrors.tuna.tsinghua.edu.cn/android/prebuilts/clang/host/linux-x86/clang-${{ env.CLANG_VERSION }}.tar.gz \
          -O clang.tar.gz
        mkdir clang-aosp && tar -xzf clang.tar.gz -C clang-aosp --strip-components 1

    - name: Build Kernel
      env:
        KBUILD_BUILD_USER: ${{ github.actor }}
        KBUILD_BUILD_HOST: GitHub-Actions
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        # å¸¦é‡è¯•çš„å…‹éš†å‘½ä»¤
        for i in {1..3}; do git clone --depth=1 --branch=${{ env.KERNEL_SOURCE_BRANCH }} ${{ env.KERNEL_SOURCE }} android-kernel && break || sleep 15; done
        
        # åº”ç”¨KernelSUè¡¥ä¸
        [ "${{ env.USE_KERNELSU }}" = "true" ] && {
          curl -sSL --retry 3 "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s -- android-kernel
        }
        
        # ç¼–è¯‘é…ç½®
        export PATH="$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$PATH"
        make -j$(nproc) -C android-kernel O=out \
          ARCH=arm64 \
          CC=clang \
          CROSS_COMPILE=aarch64-linux-android- \
          LLVM=1 \
          ${{ env.KERNEL_DEFCONFIG }}

        # æ‰§è¡Œç¼–è¯‘
        make -j$(nproc) -C android-kernel O=out \
          ARCH=arm64 \
          CC=clang \
          CROSS_COMPILE=aarch64-linux-android- \
          LLVM=1

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ env.DEVICE }}-build
        path: $GITHUB_WORKSPACE/kernel_workspace/android-kernel/out/arch/arm64/boot/
